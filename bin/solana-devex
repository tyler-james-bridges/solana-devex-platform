#!/usr/bin/env node

/**
 * Unified Solana DevEx Platform CLI
 * 
 * Integrates all platform components into a single, cohesive developer experience:
 * - Project scaffolding and building
 * - Testing with blockchain-specific matchers
 * - Enhanced Anchor development
 * - Test validator management with monitoring
 * - CI/CD and deployment automation
 * - Monitoring dashboard integration
 * - GitHub Actions template setup
 */

const { Command } = require('commander');
const chalk = require('chalk');
const path = require('path');
const fs = require('fs-extra');

const program = new Command();

program
  .name('solana-devex')
  .description('Unified Solana Developer Experience Platform')
  .version('1.0.0')
  .option('-v, --verbose', 'enable verbose output')
  .option('--config <path>', 'path to config file', 'solana-devex.config.js');

// ASCII art banner for the unified platform
const banner = chalk.cyan(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                 Solana DevEx Platform                     â•‘
â•‘           Unified Developer Experience Suite              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`);

// Display banner for interactive commands
if (process.argv.length === 2) {
  console.log(banner);
  console.log(chalk.yellow('Use --help to see available commands\n'));
}

// ===== PROJECT MANAGEMENT COMMANDS =====

program
  .command('init')
  .description('Initialize a new Solana project with full platform setup')
  .argument('[name]', 'project name')
  .option('--template <template>', 'project template (anchor, native, token, nft)', 'anchor')
  .option('--testing', 'include advanced testing setup')
  .option('--cicd', 'setup CI/CD pipeline')
  .option('--monitoring', 'include monitoring dashboard')
  .option('--validator', 'setup enhanced test validator')
  .action(async (name, options) => {
    const { initProject } = require('../packages/cli/lib/commands/init');
    const { setupTesting } = require('../packages/jest-extensions/lib/setup');
    const { setupAnchorEnhancements } = require('../packages/anchor-layer/lib/setup');
    const { setupValidator } = require('../packages/test-validator/lib/setup');
    const { setupCICD } = require('../cli/lib/commands/cicd-setup');
    
    console.log(chalk.blue('ğŸš€ Initializing Solana project with full platform integration...'));
    
    // Initialize base project
    await initProject(name, options);
    
    // Add platform integrations based on options
    if (options.testing) {
      console.log(chalk.green('ğŸ“ Setting up enhanced testing environment...'));
      await setupTesting(name);
    }
    
    if (options.cicd) {
      console.log(chalk.green('ğŸ”„ Setting up CI/CD pipeline...'));
      await setupCICD(name);
    }
    
    if (options.monitoring) {
      console.log(chalk.green('ğŸ“Š Setting up monitoring dashboard...'));
      // Setup monitoring integration
    }
    
    if (options.validator) {
      console.log(chalk.green('âš™ï¸ Setting up enhanced test validator...'));
      await setupValidator(name);
    }
    
    console.log(chalk.green('âœ… Project initialized successfully!'));
    console.log(chalk.yellow('Next steps:'));
    console.log(chalk.dim('  cd ' + (name || '.')));
    console.log(chalk.dim('  solana-devex build'));
    console.log(chalk.dim('  solana-devex test'));
  });

program
  .command('build')
  .description('Build Anchor programs and TypeScript clients')
  .option('--release', 'build optimized release version')
  .option('--verify', 'verify programs after build')
  .option('--programs <programs>', 'comma-separated list of programs to build')
  .option('--parallel', 'build programs in parallel')
  .option('--watch', 'watch for changes and rebuild')
  .action(async (options) => {
    const { buildProject } = require('../packages/cli/lib/commands/build');
    await buildProject(options);
  });

// ===== TESTING COMMANDS =====

program
  .command('test')
  .description('Run tests with blockchain-specific matchers and enhancements')
  .option('--watch', 'watch for changes and re-run tests')
  .option('--coverage', 'collect test coverage')
  .option('--validator', 'start test validator automatically')
  .option('--anchor', 'use Anchor testing enhancements')
  .option('--pattern <pattern>', 'test file pattern')
  .option('--parallel', 'run tests in parallel')
  .action(async (options) => {
    console.log(chalk.blue('ğŸ§ª Running tests with blockchain extensions...'));
    
    // Setup Jest with blockchain extensions
    const jestConfig = require('../packages/jest-extensions/jest.config');
    const { runTests } = require('../packages/jest-extensions/lib/runner');
    
    if (options.validator) {
      console.log(chalk.green('ğŸŒ Starting enhanced test validator...'));
      const { startValidator } = require('../packages/test-validator/lib/commands/start');
      await startValidator({ quiet: true });
    }
    
    await runTests(options);
  });

// ===== ANCHOR ENHANCEMENT COMMANDS =====

program
  .command('anchor')
  .description('Enhanced Anchor development tools')
  .action(() => {
    const anchorProgram = new Command();
    
    anchorProgram
      .command('enhance')
      .description('Add testing and monitoring enhancements to Anchor project')
      .action(async () => {
        const { enhanceAnchorProject } = require('../packages/anchor-layer/lib/commands/enhance');
        await enhanceAnchorProject();
      });
    
    anchorProgram
      .command('monitor')
      .description('Start Anchor program monitoring')
      .action(async () => {
        const { startMonitoring } = require('../packages/anchor-layer/lib/commands/monitor');
        await startMonitoring();
      });
    
    anchorProgram.parse(process.argv);
  });

// ===== VALIDATOR COMMANDS =====

program
  .command('validator')
  .description('Enhanced test validator management')
  .action(() => {
    const validatorProgram = new Command();
    
    validatorProgram
      .command('start')
      .description('Start enhanced test validator with monitoring')
      .option('--port <port>', 'RPC port', '8899')
      .option('--reset', 'reset validator state')
      .option('--monitor', 'enable performance monitoring')
      .action(async (options) => {
        const { startValidator } = require('../packages/test-validator/cli/index');
        await startValidator(options);
      });
    
    validatorProgram
      .command('stop')
      .description('Stop test validator')
      .action(async () => {
        const { stopValidator } = require('../packages/test-validator/lib/commands/stop');
        await stopValidator();
      });
    
    validatorProgram
      .command('monitor')
      .description('Show validator performance dashboard')
      .action(async () => {
        const { showMonitor } = require('../packages/test-validator/lib/commands/monitor');
        await showMonitor();
      });
    
    validatorProgram.parse(process.argv);
  });

// ===== CI/CD COMMANDS =====

program
  .command('cicd')
  .description('CI/CD pipeline management')
  .action(() => {
    const cicdProgram = new Command();
    
    cicdProgram
      .command('setup')
      .description('Setup CI/CD pipeline for current project')
      .action(async () => {
        const { setupPipeline } = require('../cli/lib/commands/cicd-setup');
        await setupPipeline();
      });
    
    cicdProgram
      .command('actions')
      .description('Setup GitHub Actions templates')
      .action(async () => {
        const { setupGitHubActions } = require('../packages/github-actions/lib/setup');
        await setupGitHubActions();
      });
    
    cicdProgram.parse(process.argv);
  });

// ===== MONITORING COMMANDS =====

program
  .command('monitor')
  .description('Platform monitoring and dashboard')
  .action(() => {
    const monitorProgram = new Command();
    
    monitorProgram
      .command('start')
      .description('Start monitoring dashboard')
      .option('--port <port>', 'dashboard port', '3000')
      .action(async (options) => {
        console.log(chalk.blue('ğŸ“Š Starting monitoring dashboard...'));
        const { spawn } = require('child_process');
        const dashboard = spawn('npm', ['run', 'dev'], { 
          stdio: 'inherit',
          env: { ...process.env, PORT: options.port }
        });
      });
    
    monitorProgram
      .command('api')
      .description('Start monitoring API server')
      .action(async () => {
        const { spawn } = require('child_process');
        const api = spawn('npm', ['run', 'api:dev'], { stdio: 'inherit' });
      });
    
    monitorProgram.parse(process.argv);
  });

// ===== UTILITY COMMANDS =====

program
  .command('config')
  .description('Manage platform configuration')
  .action(() => {
    const configProgram = new Command();
    
    configProgram
      .command('init')
      .description('Initialize platform configuration')
      .action(async () => {
        const { initConfig } = require('../packages/shared/lib/config');
        await initConfig();
      });
    
    configProgram
      .command('show')
      .description('Show current configuration')
      .action(async () => {
        const { showConfig } = require('../packages/shared/lib/config');
        await showConfig();
      });
    
    configProgram.parse(process.argv);
  });

program
  .command('setup')
  .description('Complete platform setup guide')
  .action(async () => {
    console.log(banner);
    console.log(chalk.blue('ğŸ› ï¸ Welcome to the Solana DevEx Platform setup!'));
    console.log(chalk.dim('This will guide you through setting up the complete development environment.\n'));
    
    const { runSetupWizard } = require('../lib/setup-wizard');
    await runSetupWizard();
  });

// Help enhancement
const originalHelp = program.outputHelp;
program.outputHelp = function(cb) {
  console.log(banner);
  return originalHelp.call(this, cb);
};

// Error handling
program.on('command:*', () => {
  console.error(chalk.red('Invalid command: %s'), program.args.join(' '));
  console.log(chalk.yellow('See --help for a list of available commands.'));
  process.exit(1);
});

program.parse(process.argv);

// Show help if no command provided
if (!process.argv.slice(2).length) {
  program.outputHelp();
}