#!/usr/bin/env node

/**
 * Solana DevEx Platform - Unified CLI
 * Official Solana Stack Made Easy
 * 
 * This CLI provides streamlined access to the official Solana development stack:
 * - @solana/client + @solana/react-hooks for UI
 * - @solana/kit for client/RPC/transaction operations
 * - LiteSVM/Mollusk/Surfpool for testing
 * - Anchor-first with Pinocchio option
 * - Wallet-standard-first connections
 */

const { program } = require('commander');
const chalk = require('chalk');
const { version } = require('../package.json');

// Command handlers
const initCommands = require('../cli/commands/init');
const kitCommands = require('../cli/commands/kit');
const testCommands = require('../cli/commands/test');
const anchorCommands = require('../cli/commands/anchor');
const pinocchioCommands = require('../cli/commands/pinocchio');
const walletCommands = require('../cli/commands/wallet');
const securityCommands = require('../cli/commands/security');
const compatCommands = require('../cli/commands/compat');

// Configure main program
program
  .name('solana-devex')
  .description(chalk.cyan('ðŸš€ Official Solana Stack Made Easy\n') + 
               chalk.gray('DevEx layer for framework-kit + @solana/kit ecosystem'))
  .version(version, '-v, --version', 'display version number')
  .helpOption('-h, --help', 'display help for command');

// Core commands following official stack
program
  .command('init')
  .description('Initialize new project with official Solana stack')
  .option('-t, --template <type>', 'project template', 'react-kit')
  .option('--kit-only', 'pure @solana/kit project (no UI)')
  .option('--anchor', 'include Anchor program workspace')
  .option('--pinocchio', 'use Pinocchio for high-performance programs')
  .option('--legacy', 'use legacy web3.js stack (not recommended)')
  .action(initCommands.init);

// @solana/kit operations
const kit = program
  .command('kit')
  .description('Official @solana/kit operations');

kit
  .command('rpc')
  .description('RPC client management with @solana/kit')
  .option('-e, --endpoint <url>', 'RPC endpoint')
  .action(kitCommands.rpc);

kit
  .command('transaction')
  .description('Build and send transactions with @solana/kit')
  .option('-s, --simulate', 'simulate transaction only')
  .action(kitCommands.transaction);

kit
  .command('client')
  .description('Generate typed clients with Codama')
  .option('-i, --idl <path>', 'IDL file path')
  .action(kitCommands.client);

// Testing with official stack (LiteSVM/Mollusk/Surfpool)
const test = program
  .command('test')
  .description('Test with official testing stack');

test
  .command('unit')
  .description('Run unit tests with LiteSVM/Mollusk')
  .option('--mollusk', 'use Mollusk testing patterns')
  .option('--litesvm', 'use LiteSVM (default)')
  .action(testCommands.unit);

test
  .command('integration')
  .description('Run integration tests with Surfpool')
  .option('--mainnet', 'test against mainnet state')
  .option('--devnet', 'test against devnet state')
  .action(testCommands.integration);

test
  .command('legacy')
  .description('Fallback to solana-test-validator')
  .action(testCommands.legacy);

// Anchor (default) and Pinocchio (performance)
program
  .command('anchor')
  .description('Anchor program development (default choice)')
  .option('-b, --build', 'build programs')
  .option('-t, --test', 'run Anchor tests')
  .option('-d, --deploy', 'deploy to cluster')
  .action(anchorCommands.main);

program
  .command('pinocchio')
  .description('High-performance programs with Pinocchio')
  .option('-o, --optimize', 'optimize for compute units')
  .action(pinocchioCommands.main);

// Wallet-standard-first connections
program
  .command('wallet')
  .description('Wallet-standard connection patterns')
  .option('-s, --setup', 'setup wallet connection')
  .action(walletCommands.main);

// Automated security checklist
program
  .command('security')
  .description('Automated security analysis and checklist')
  .option('-a, --audit', 'run full security audit')
  .option('-r, --risks', 'analyze signing/fee/CPI risks')
  .action(securityCommands.main);

// Legacy web3.js compatibility (contained boundaries)
program
  .command('compat')
  .description('web3.js compatibility layer (use sparingly)')
  .option('-m, --migrate', 'help migrate from web3.js to @solana/kit')
  .action(compatCommands.main);

// Platform management (existing functionality)
program
  .command('setup')
  .description('Setup platform environment')
  .action(() => require('../cli/platform').setup());

program
  .command('monitor')
  .description('Start monitoring dashboard')
  .action(() => require('../cli/platform').monitor());

program
  .command('config')
  .description('Configure platform settings')
  .action(() => require('../cli/platform').config());

// Global error handling
program.on('command:*', () => {
  console.error(chalk.red(`Unknown command: ${program.args.join(' ')}`));
  console.log(chalk.yellow('Run "solana-devex --help" to see available commands'));
  process.exit(1);
});

// Parse and execute
program.parse();

// Show help if no command provided
if (!process.argv.slice(2).length) {
  program.outputHelp();
  console.log('\n' + chalk.cyan('ðŸŽ¯ Quick Start:'));
  console.log(chalk.gray('  solana-devex init my-project    # Create new official stack project'));
  console.log(chalk.gray('  solana-devex test unit          # Run fast unit tests with LiteSVM'));
  console.log(chalk.gray('  solana-devex security --audit   # Run security analysis'));
  console.log('\n' + chalk.yellow('ðŸ“š Learn more: https://docs.solana-devex.io'));
}