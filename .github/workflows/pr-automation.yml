name: PR Automation & Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches: [ main, develop ]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]

jobs:
  # Automated PR Checks and Labeling
  pr-checks:
    name: PR Analysis & Labeling
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: PR Size Labeling
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const changes = additions + deletions;
            
            let sizeLabel = '';
            if (changes < 10) sizeLabel = 'size/XS';
            else if (changes < 30) sizeLabel = 'size/S';
            else if (changes < 100) sizeLabel = 'size/M';
            else if (changes < 500) sizeLabel = 'size/L';
            else sizeLabel = 'size/XL';
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: [sizeLabel]
            });

      - name: Check for breaking changes
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title.toLowerCase();
            const body = pr.body ? pr.body.toLowerCase() : '';
            
            const breakingKeywords = [
              'breaking change', 'breaking:', 'break:', 'bc:',
              'major:', 'incompatible', 'removes', 'deprecated'
            ];
            
            const hasBreakingChange = breakingKeywords.some(keyword => 
              title.includes(keyword) || body.includes(keyword)
            );
            
            if (hasBreakingChange) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['breaking-change']
              });
            }

      - name: Auto-assign reviewers
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            
            // Skip if already has reviewers or is draft
            if (pr.draft || pr.requested_reviewers.length > 0) return;
            
            // Define code owners/reviewers based on changed files
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_request_number: pr.number
            });
            
            let reviewers = [];
            const changedFiles = files.map(f => f.filename);
            
            if (changedFiles.some(f => f.includes('api/'))) {
              reviewers.push('backend-team');
            }
            if (changedFiles.some(f => f.includes('app/') || f.includes('components/'))) {
              reviewers.push('frontend-team');
            }
            if (changedFiles.some(f => f.includes('cli/'))) {
              reviewers.push('cli-team');
            }
            
            if (reviewers.length > 0) {
              // Add team reviewers (adjust team names as needed)
              console.log('Would assign reviewers:', reviewers);
            }

  # Dependency Update Automation
  dependency-update:
    name: Automated Dependency Updates
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' && 
      (contains(github.head_ref, 'dependabot') || contains(github.head_ref, 'deps/'))
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Auto-approve minor updates
        uses: actions/github-script@v7
        if: contains(github.head_ref, 'dependabot')
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title.toLowerCase();
            
            // Auto-approve patch and minor updates
            if (title.includes('bump') && (title.includes('patch') || title.includes('minor'))) {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_request_number: pr.number,
                event: 'APPROVE',
                body: 'ü§ñ Auto-approving patch/minor dependency update'
              });
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['auto-merge', 'dependencies']
              });
            }

  # Auto-merge eligibility check
  auto-merge-check:
    name: Auto-Merge Eligibility
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'auto-merge')) ||
      (github.event_name == 'pull_request_review' && github.event.review.state == 'approved') ||
      (github.event_name == 'check_suite' && github.event.check_suite.conclusion == 'success')
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Check auto-merge eligibility
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            
            // Get PR number based on event type
            let prNumber;
            if (context.eventName === 'pull_request') {
              prNumber = context.payload.pull_request.number;
            } else if (context.eventName === 'pull_request_review') {
              prNumber = context.payload.pull_request.number;
            } else if (context.eventName === 'check_suite') {
              // Find PR associated with this check suite
              const { data: prs } = await github.rest.pulls.list({
                owner,
                repo,
                head: context.payload.check_suite.head_branch,
                state: 'open'
              });
              if (prs.length === 0) return;
              prNumber = prs[0].number;
            }
            
            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_request_number: prNumber
            });
            
            // Check if PR has auto-merge label
            const hasAutoMerge = pr.labels.some(label => label.name === 'auto-merge');
            if (!hasAutoMerge) {
              console.log('PR does not have auto-merge label');
              return;
            }
            
            // Check if PR is ready for auto-merge
            const checks = await github.rest.checks.listForRef({
              owner,
              repo,
              ref: pr.head.sha
            });
            
            const requiredChecks = [
              'Code Quality & Linting',
              'Security Scanning',
              'Test Suite',
              'Build Verification'
            ];
            
            const passedChecks = checks.data.check_runs
              .filter(check => requiredChecks.includes(check.name))
              .filter(check => check.conclusion === 'success');
            
            console.log(`Passed checks: ${passedChecks.length}/${requiredChecks.length}`);
            
            // Check if all required checks passed
            if (passedChecks.length !== requiredChecks.length) {
              console.log('Not all required checks have passed');
              return;
            }
            
            // Check for required approvals
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner,
              repo,
              pull_request_number: prNumber
            });
            
            const approvals = reviews.filter(review => review.state === 'APPROVED');
            const hasRequiredApprovals = approvals.length >= 1; // Require at least 1 approval
            
            if (!hasRequiredApprovals) {
              console.log('PR does not have required approvals');
              return;
            }
            
            // Check if PR is mergeable
            if (!pr.mergeable || pr.draft) {
              console.log('PR is not mergeable or is draft');
              return;
            }
            
            // All checks passed - proceed with auto-merge
            console.log('All conditions met - proceeding with auto-merge');
            
            try {
              await github.rest.pulls.merge({
                owner,
                repo,
                pull_request_number: prNumber,
                merge_method: 'squash', // or 'merge' or 'rebase' based on your preference
                commit_title: `${pr.title} (#${prNumber})`,
                commit_message: `Automatically merged by GitHub Actions\n\n${pr.body || ''}`
              });
              
              console.log(`Successfully auto-merged PR #${prNumber}`);
              
              // Add success comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: 'üéâ This PR has been automatically merged after passing all required checks!'
              });
              
            } catch (error) {
              console.error('Failed to auto-merge:', error);
              
              // Add failure comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: '‚ùå Auto-merge failed. Please merge manually or check for conflicts.'
              });
            }

  # Quality gate enforcement
  quality-gate:
    name: Quality Gate Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check code coverage threshold
        working-directory: ./api
        run: |
          npm ci
          npm test -- --coverage --coverageThreshold='{"global":{"branches":70,"functions":70,"lines":70,"statements":70}}'

      - name: Check bundle size
        run: |
          npm run build
          # Add bundle size checks here

      - name: Validate commit message
        if: github.event_name == 'pull_request'
        run: |
          echo "Validating commit messages..."
          # Add commit message validation logic
          echo "‚úÖ Commit messages are valid"